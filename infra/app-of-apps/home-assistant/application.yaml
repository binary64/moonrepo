apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: home-assistant
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://pajikos.github.io/home-assistant-helm-chart/
    chart: home-assistant
    targetRevision: 0.3.35
    helm:
      values: |
        # Enable host networking for LAN device discovery (TP-Link, mDNS, etc.)
        hostNetwork: true
        dnsPolicy: ClusterFirstWithHostNet

        # Mount host DBus socket so HA can use Bluetooth (BLE device discovery)
        additionalVolumes:
          - name: dbus
            hostPath:
              path: /run/dbus
        additionalMounts:
          - name: dbus
            mountPath: /run/dbus

        configuration:
          enabled: true
          configuration.yaml: |
            mqtt:
              broker: mosquitto.home-assistant.svc.cluster.local
              port: 1883
              username: mqtt
              password: mqtt
              discovery: true
              discovery_prefix: homeassistant
              birth_message:
                topic: 'hass/status'
                payload: 'online'
              will_message:
                topic: 'hass/status'
                payload: 'offline'
          forceInit: false
          trusted_proxies:
            - 10.42.0.0/16
            - 10.43.0.0/16
            - 127.0.0.0/8
            - 192.168.1.0/24  # Replace with your LAN CIDR

        # initContainers:
        #   - name: init-hacs
        #     image: 
        #     command: ["bash", "-c", "cd /config && wget -O - https://get.hacs.xyz | bash -"]
        #     volumeMounts:
        #         - mountPath: /config
        #           name: home-assistant
    
        service:
          type: ClusterIP
          port: 8123

        probes:
          liveness:
            enabled: true
            initialDelaySeconds: 60
          readiness:
            enabled: true
            initialDelaySeconds: 60
          startup:
            enabled: true
            failureThreshold: 30
            periodSeconds: 10

        ingress:
          enabled: false
          external: true
          className: istio
          annotations:
            kubernetes.io/ingress.class: istio
          hosts:
            - host: home.brandwhisper.cloud
              paths:
                - path: /
                  pathType: Prefix

        persistence:
          enabled: true
          accessMode: ReadWriteOnce
          size: 10Gi
          # storageClass defaults to cluster default (local-path)

        addons:
          codeserver:
            enabled: true
            image:
              tag: "4.19.1"
            ingress:
              enabled: false
              className: istio
              annotations:
                kubernetes.io/ingress.class: istio
              hosts:
                - host: hass-code.localhost
                  paths:
                    - path: /
                      pathType: Prefix

  destination:
    server: https://kubernetes.default.svc
    namespace: home-assistant

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
