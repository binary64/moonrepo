# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/argoproj.io/application_v1alpha1.json
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: istio
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://istio-release.storage.googleapis.com/charts
    targetRevision: 1.20.2
    chart: istio
    helm:
      releaseName: istio
      values: |
        global:
          istioNamespace: istio-system
          logAsJson: true

        meshConfig:
          enableAutoMTLS: true
          ingressControllerMode: "DEFAULT"
          accessLogFile: /dev/stdout
          accessLogFormat: |
            [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
            %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
            "%DURATION%" "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
            "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%"
            "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"

        pilot:
          autoscalingv2Enabled: true
          replicaCount: 2
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 2000m
              memory: 1024Mi
          env:
            PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION: "true"
            PILOT_ENABLE_ANALYSIS: "true"

        istiodRemote:
          enabled: false

        gateways:
          istio-ingressgateway:
            enabled: true
            namespace: istio-system
            replicaCount: 2
            autoscalingv2Enabled: true
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 2000m
                memory: 1024Mi
            type: LoadBalancer
            # For NodePort, use: type: NodePort
            env:
              ISTIO_META_ROUTER_MODE: "sni-dnat"
          istio-egressgateway:
            enabled: true
            namespace: istio-system
            replicaCount: 1
            autoscalingv2Enabled: true
            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                cpu: 2000m
                memory: 1024Mi

  destination:
    server: https://kubernetes.default.svc
    namespace: istio-system

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
